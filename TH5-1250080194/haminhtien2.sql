CREATE TABLE XE (
    MAXE    VARCHAR2(5) PRIMARY KEY,
    BIENKS  VARCHAR2(15),
    MATUYEN VARCHAR2(5),
    SOGHET1 NUMBER,
    SOGHET2 NUMBER
);
CREATE TABLE TUYEN (
    MATUYEN  VARCHAR2(5) PRIMARY KEY,
    BENDAU   VARCHAR2(30),
    BENCUOI  VARCHAR2(30),
    GIATUYEN NUMBER,
    NGXB     DATE,
    TGDK     NUMBER
);
CREATE TABLE KHACH (
    MAHK     VARCHAR2(5) PRIMARY KEY,
    HOTEN    VARCHAR2(50),
    GIOITINH VARCHAR2(5),
    CMND     VARCHAR2(15)
);
CREATE TABLE VE (
    MATUYEN VARCHAR2(5),
    MAHK    VARCHAR2(5),
    NGMUA   DATE,
    GIAVE   NUMBER,
    CONSTRAINT PK_VE PRIMARY KEY (MATUYEN, MAHK, NGMUA),
    CONSTRAINT FK_VE_TUYEN FOREIGN KEY (MATUYEN) REFERENCES TUYEN(MATUYEN),
    CONSTRAINT FK_VE_KHACH FOREIGN KEY (MAHK) REFERENCES KHACH(MAHK)
);
INSERT INTO XE VALUES ('X01', '52LD-4393', 'T11A', 20, 20);
INSERT INTO XE VALUES ('X02', '59LD-7247', 'T32D', 36, 36);
INSERT INTO XE VALUES ('X03', '55LD-6850', 'T06F', 15, 15);
INSERT INTO TUYEN VALUES ('T11A', 'SG', 'DL', 210000, TO_DATE('26/12/2016','DD/MM/YYYY'), 6);
INSERT INTO TUYEN VALUES ('T32D', 'PT', 'SG', 120000, TO_DATE('30/12/2016','DD/MM/YYYY'), 4);
INSERT INTO TUYEN VALUES ('T06F', 'NT', 'DNG', 225000, TO_DATE('02/01/2017','DD/MM/YYYY'), 7);
INSERT INTO KHACH VALUES ('KH01', 'Lâm V?n B?n', 'Nam', '655615896');
INSERT INTO KHACH VALUES ('KH02', 'D??ng Th? L?c', 'N?', '275648642');
INSERT INTO KHACH VALUES ('KH03', 'Hoàng Thanh Tùng', 'Nam', '456889143');
INSERT INTO VE VALUES ('T11A', 'KH01', TO_DATE('20/12/2016','DD/MM/YYYY'), 210000);
INSERT INTO VE VALUES ('T32D', 'KH02', TO_DATE('25/12/2016','DD/MM/YYYY'), 144000);
INSERT INTO VE VALUES ('T06F', 'KH03', TO_DATE('30/12/2016','DD/MM/YYYY'), 270000);
COMMIT;

1
-- T?o user

CREATE USER BAITHI IDENTIFIED BY BAITHI123;

GRANT CONNECT, RESOURCE TO BAITHI;

CREATE TABLE XE (
    MAXE    VARCHAR2(5) PRIMARY KEY,
    BIENKS  VARCHAR2(15),
    MATUYEN VARCHAR2(5),
    SOGHET1 NUMBER,
    SOGHET2 NUMBER
);

CREATE TABLE TUYEN (
    MATUYEN  VARCHAR2(5) PRIMARY KEY,
    BENDAU   VARCHAR2(30),
    BENCUOI  VARCHAR2(30),
    GIATUYEN NUMBER,
    NGXB     DATE,
    TGDK     NUMBER
);

CREATE TABLE KHACH (
    MAHK     VARCHAR2(5) PRIMARY KEY,
    HOTEN    VARCHAR2(50),
    GIOITINH VARCHAR2(5),
    CMND     VARCHAR2(15)
);

CREATE TABLE VEXE (
    MATUYEN VARCHAR2(5),
    MAHK    VARCHAR2(5),
    NGMUA   DATE,
    GIAVE   NUMBER,
    CONSTRAINT PK_VEXE PRIMARY KEY (MATUYEN, MAHK, NGMUA),
    CONSTRAINT FK_VEXE_TUYEN FOREIGN KEY (MATUYEN) REFERENCES TUYEN(MATUYEN),
    CONSTRAINT FK_VEXE_KHACH FOREIGN KEY (MAHK) REFERENCES KHACH(MAHK)
);
2
INSERT INTO XE VALUES ('X01','52LD-4393','T11A',20,20);
INSERT INTO XE VALUES ('X02','59LD-7247','T32D',36,36);
INSERT INTO XE VALUES ('X03','55LD-6850','T06F',15,15);

INSERT INTO TUYEN VALUES ('T11A','SG','DL',210000,TO_DATE('26/12/2016','DD/MM/YYYY'),6);
INSERT INTO TUYEN VALUES ('T32D','PT','SG',120000,TO_DATE('30/12/2016','DD/MM/YYYY'),4);
INSERT INTO TUYEN VALUES ('T06F','NT','DNG',225000,TO_DATE('02/01/2017','DD/MM/YYYY'),7);

INSERT INTO KHACH VALUES ('KH01','Lâm V?n B?n','Nam','655615896');
INSERT INTO KHACH VALUES ('KH02','D??ng Th? L?c','N?','275648642');
INSERT INTO KHACH VALUES ('KH03','Hoàng Thanh Tùng','Nam','456889143');

INSERT INTO VEXE VALUES ('T11A','KH01',TO_DATE('20/12/2016','DD/MM/YYYY'),210000);
INSERT INTO VEXE VALUES ('T32D','KH02',TO_DATE('25/12/2016','DD/MM/YYYY'),144000);
INSERT INTO VEXE VALUES ('T06F','KH03',TO_DATE('30/12/2016','DD/MM/YYYY'),270000);

COMMIT;
3
ALTER TABLE TUYEN
ADD CONSTRAINT CK_TUYEN_GIA
CHECK (TGDK <= 5 OR GIATUYEN > 200000);
4
CREATE OR REPLACE TRIGGER TRG_TANG_GIAVE
BEFORE INSERT OR UPDATE ON VEXE
FOR EACH ROW
DECLARE
    V_NGXB DATE;
BEGIN
    SELECT NGXB INTO V_NGXB
    FROM TUYEN
    WHERE MATUYEN = :NEW.MATUYEN;

    IF V_NGXB BETWEEN TO_DATE('29/12/2016','DD/MM/YYYY')
                 AND TO_DATE('05/01/2017','DD/MM/YYYY') THEN
        :NEW.GIAVE := :NEW.GIAVE * 1.2;
    END IF;
END;
5
SELECT *
FROM VEXE
WHERE EXTRACT(MONTH FROM NGMUA) = 12
ORDER BY GIAVE DESC;
6
SELECT MATUYEN
FROM VEXE
WHERE EXTRACT(YEAR FROM NGMUA) = 2016
GROUP BY MATUYEN
HAVING COUNT(*) = (
    SELECT MIN(COUNT(*))
    FROM VEXE
    WHERE EXTRACT(YEAR FROM NGMUA) = 2016
    GROUP BY MATUYEN
);
7
SELECT VX.MATUYEN
FROM VEXE VX
JOIN KHACH K ON VX.MAHK = K.MAHK
GROUP BY VX.MATUYEN
HAVING COUNT(DISTINCT K.GIOITINH) = 2;
8
SELECT K.MAHK, K.HOTEN
FROM KHACH K
WHERE K.GIOITINH = 'N?'
AND NOT EXISTS (
    SELECT *
    FROM TUYEN T
    WHERE NOT EXISTS (
        SELECT *
        FROM VEXE V
        WHERE V.MATUYEN = T.MATUYEN
        AND V.MAHK = K.MAHK
    )
);





