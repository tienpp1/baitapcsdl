CREATE TABLE XE (
    MAXE    VARCHAR2(5) PRIMARY KEY,
    BIENKS  VARCHAR2(15),
    MATUYEN VARCHAR2(5),
    SOGHET1 NUMBER,
    SOGHET2 NUMBER
);
CREATE TABLE TUYEN (
    MATUYEN  VARCHAR2(5) PRIMARY KEY,
    BENDAU   VARCHAR2(30),
    BENCUOI  VARCHAR2(30),
    GIATUYEN NUMBER,
    NGXB     DATE,
    TGDK     NUMBER
);
CREATE TABLE KHACH (
    MAHK     VARCHAR2(5) PRIMARY KEY,
    HOTEN    VARCHAR2(50),
    GIOITINH VARCHAR2(5),
    CMND     VARCHAR2(15)
);
CREATE TABLE VE (
    MATUYEN VARCHAR2(5),
    MAHK    VARCHAR2(5),
    NGMUA   DATE,
    GIAVE   NUMBER,
    CONSTRAINT PK_VE PRIMARY KEY (MATUYEN, MAHK, NGMUA),
    CONSTRAINT FK_VE_TUYEN FOREIGN KEY (MATUYEN) REFERENCES TUYEN(MATUYEN),
    CONSTRAINT FK_VE_KHACH FOREIGN KEY (MAHK) REFERENCES KHACH(MAHK)
);
INSERT INTO XE VALUES ('X01', '52LD-4393', 'T11A', 20, 20);
INSERT INTO XE VALUES ('X02', '59LD-7247', 'T32D', 36, 36);
INSERT INTO XE VALUES ('X03', '55LD-6850', 'T06F', 15, 15);
INSERT INTO TUYEN VALUES ('T11A', 'SG', 'DL', 210000, TO_DATE('26/12/2016','DD/MM/YYYY'), 6);
INSERT INTO TUYEN VALUES ('T32D', 'PT', 'SG', 120000, TO_DATE('30/12/2016','DD/MM/YYYY'), 4);
INSERT INTO TUYEN VALUES ('T06F', 'NT', 'DNG', 225000, TO_DATE('02/01/2017','DD/MM/YYYY'), 7);
INSERT INTO KHACH VALUES ('KH01', 'Lâm V?n B?n', 'Nam', '655615896');
INSERT INTO KHACH VALUES ('KH02', 'D??ng Th? L?c', 'N?', '275648642');
INSERT INTO KHACH VALUES ('KH03', 'Hoàng Thanh Tùng', 'Nam', '456889143');
INSERT INTO VE VALUES ('T11A', 'KH01', TO_DATE('20/12/2016','DD/MM/YYYY'), 210000);
INSERT INTO VE VALUES ('T32D', 'KH02', TO_DATE('25/12/2016','DD/MM/YYYY'), 144000);
INSERT INTO VE VALUES ('T06F', 'KH03', TO_DATE('30/12/2016','DD/MM/YYYY'), 270000);
COMMIT;

1
-- T?o user

CREATE USER BAITHI IDENTIFIED BY BAITHI123;

GRANT CONNECT, RESOURCE TO BAITHI;

CREATE TABLE XE (
    MAXE    VARCHAR2(5) PRIMARY KEY,
    BIENKS  VARCHAR2(15),
    MATUYEN VARCHAR2(5),
    SOGHET1 NUMBER,
    SOGHET2 NUMBER
);

CREATE TABLE TUYEN (
    MATUYEN  VARCHAR2(5) PRIMARY KEY,
    BENDAU   VARCHAR2(30),
    BENCUOI  VARCHAR2(30),
    GIATUYEN NUMBER,
    NGXB     DATE,
    TGDK     NUMBER
);

CREATE TABLE KHACH (
    MAHK     VARCHAR2(5) PRIMARY KEY,
    HOTEN    VARCHAR2(50),
    GIOITINH VARCHAR2(5),
    CMND     VARCHAR2(15)
);

CREATE TABLE VEXE (
    MATUYEN VARCHAR2(5),
    MAHK    VARCHAR2(5),
    NGMUA   DATE,
    GIAVE   NUMBER,
    CONSTRAINT PK_VEXE PRIMARY KEY (MATUYEN, MAHK, NGMUA),
    CONSTRAINT FK_VEXE_TUYEN FOREIGN KEY (MATUYEN) REFERENCES TUYEN(MATUYEN),
    CONSTRAINT FK_VEXE_KHACH FOREIGN KEY (MAHK) REFERENCES KHACH(MAHK)
);
2
INSERT INTO XE VALUES ('X01','52LD-4393','T11A',20,20);
INSERT INTO XE VALUES ('X02','59LD-7247','T32D',36,36);
INSERT INTO XE VALUES ('X03','55LD-6850','T06F',15,15);

INSERT INTO TUYEN VALUES ('T11A','SG','DL',210000,TO_DATE('26/12/2016','DD/MM/YYYY'),6);
INSERT INTO TUYEN VALUES ('T32D','PT','SG',120000,TO_DATE('30/12/2016','DD/MM/YYYY'),4);
INSERT INTO TUYEN VALUES ('T06F','NT','DNG',225000,TO_DATE('02/01/2017','DD/MM/YYYY'),7);

INSERT INTO KHACH VALUES ('KH01','Lâm V?n B?n','Nam','655615896');
INSERT INTO KHACH VALUES ('KH02','D??ng Th? L?c','N?','275648642');
INSERT INTO KHACH VALUES ('KH03','Hoàng Thanh Tùng','Nam','456889143');

INSERT INTO VEXE VALUES ('T11A','KH01',TO_DATE('20/12/2016','DD/MM/YYYY'),210000);
INSERT INTO VEXE VALUES ('T32D','KH02',TO_DATE('25/12/2016','DD/MM/YYYY'),144000);
INSERT INTO VEXE VALUES ('T06F','KH03',TO_DATE('30/12/2016','DD/MM/YYYY'),270000);

COMMIT;
3
ALTER TABLE TUYEN
ADD CONSTRAINT CK_TUYEN_GIA
CHECK (TGDK <= 5 OR GIATUYEN > 200000);
4
CREATE OR REPLACE TRIGGER TRG_TANG_GIAVE
BEFORE INSERT OR UPDATE ON VEXE
FOR EACH ROW
DECLARE
    V_NGXB DATE;
BEGIN
    SELECT NGXB INTO V_NGXB
    FROM TUYEN
    WHERE MATUYEN = :NEW.MATUYEN;

    IF V_NGXB BETWEEN TO_DATE('29/12/2016','DD/MM/YYYY')
                 AND TO_DATE('05/01/2017','DD/MM/YYYY') THEN
        :NEW.GIAVE := :NEW.GIAVE * 1.2;
    END IF;
END;
5
SELECT *
FROM VEXE
WHERE EXTRACT(MONTH FROM NGMUA) = 12
ORDER BY GIAVE DESC;
6
SELECT MATUYEN
FROM VEXE
WHERE EXTRACT(YEAR FROM NGMUA) = 2016
GROUP BY MATUYEN
HAVING COUNT(*) = (
    SELECT MIN(COUNT(*))
    FROM VEXE
    WHERE EXTRACT(YEAR FROM NGMUA) = 2016
    GROUP BY MATUYEN
);
7
SELECT VX.MATUYEN
FROM VEXE VX
JOIN KHACH K ON VX.MAHK = K.MAHK
GROUP BY VX.MATUYEN
HAVING COUNT(DISTINCT K.GIOITINH) = 2;
8
SELECT K.MAHK, K.HOTEN
FROM KHACH K
WHERE K.GIOITINH = 'N?'
AND NOT EXISTS (
    SELECT *
    FROM TUYEN T
    WHERE NOT EXISTS (
        SELECT *
        FROM VEXE V
        WHERE V.MATUYEN = T.MATUYEN
        AND V.MAHK = K.MAHK
    )
);

--bai2
--------------------------------------------------
-- 1. T?O USER BAITHI
--------------------------------------------------
ALTER SESSION SET "_ORACLE_SCRIPT"=TRUE;

CREATE USER BAITHI IDENTIFIED BY 123;
GRANT CONNECT, RESOURCE TO BAITHI;

--------------------------------------------------
-- 2. ??NG NH?P USER BAITHI
--------------------------------------------------
CONNECT BAITHI/123;

--------------------------------------------------
-- 3. T?O B?NG USER
--------------------------------------------------
CREATE TABLE USERS (
    UID         VARCHAR2(3),
    USERNAME    VARCHAR2(30) NOT NULL,
    PASS        VARCHAR2(30) NOT NULL,
    REGDAY      DATE DEFAULT SYSDATE,
    NATIONALITY VARCHAR2(30),
    CONSTRAINT PK_USERS PRIMARY KEY (UID)
);


--------------------------------------------------
-- 4. T?O B?NG CHANNEL
--------------------------------------------------
CREATE TABLE CHANNEL (
    CHANNELID  VARCHAR2(5),
    CNAME      VARCHAR2(50),
    SUBSCRIBES NUMBER,
    OWNER      VARCHAR2(3),
    CREATED    DATE,
    CONSTRAINT PK_CHANNEL PRIMARY KEY (CHANNELID),
    CONSTRAINT FK_CHANNEL_USER FOREIGN KEY (OWNER)
        REFERENCES "USER"(UID),
    CONSTRAINT CK_CREATED CHECK (CREATED >= 
        (SELECT REGDAY FROM "USER" WHERE UID = OWNER))
);

--------------------------------------------------
-- 5. T?O B?NG VIDEO
--------------------------------------------------
CREATE TABLE VIDEO (
    VIDEOID  VARCHAR2(10),
    TITLE    VARCHAR2(100),
    DURATION NUMBER,
    AGE      NUMBER,
    CONSTRAINT PK_VIDEO PRIMARY KEY (VIDEOID),
    CONSTRAINT CK_VIDEO_AGE CHECK (AGE >= 0)
);

--------------------------------------------------
-- 6. T?O B?NG SHARE
--------------------------------------------------
CREATE TABLE SHARE (
    VIDEOID   VARCHAR2(10),
    CHANNELID VARCHAR2(5),
    CONSTRAINT PK_SHARE PRIMARY KEY (VIDEOID, CHANNELID),
    CONSTRAINT FK_SHARE_VIDEO FOREIGN KEY (VIDEOID)
        REFERENCES VIDEO(VIDEOID),
    CONSTRAINT FK_SHARE_CHANNEL FOREIGN KEY (CHANNELID)
        REFERENCES CHANNEL(CHANNELID)
);

--------------------------------------------------
-- 7. NH?P D? LI?U USER
--------------------------------------------------
INSERT INTO "USER" VALUES ('001','faptv','123456abc',DATE '2014-01-01','Vi?t Nam');
INSERT INTO "USER" VALUES ('002','kemxoilv','@147869iii',DATE '2015-06-05','Campuchia');
INSERT INTO "USER" VALUES ('003','openshare','qwertyuiop',DATE '2009-05-12','Vi?t Nam');

--------------------------------------------------
-- 8. NH?P D? LI?U CHANNEL
--------------------------------------------------
INSERT INTO CHANNEL VALUES ('C120','FAP TV',2343,'001',DATE '2014-01-02');
INSERT INTO CHANNEL VALUES ('C905','Kem xôi TV',1032,'002',DATE '2015-09-09');
INSERT INTO CHANNEL VALUES ('C357','OpenShare Cafe',5064,'003',DATE '2010-12-10');

--------------------------------------------------
-- 9. NH?P D? LI?U VIDEO
--------------------------------------------------
INSERT INTO VIDEO VALUES ('V100229','FAPtv C?m Ngu?i T?p 41 - ??t Nh?p',469,18);
INSERT INTO VIDEO VALUES ('V211002','Kem xôi: T?p 31 - Máy Kool tình yêu c?a anh',312,16);
INSERT INTO VIDEO VALUES ('V400002','N?i tình yêu k?t thúc - Hoàng Tu?n',378,0);

--------------------------------------------------
-- 10. NH?P D? LI?U SHARE
--------------------------------------------------
INSERT INTO SHARE VALUES ('V100229','C905');
INSERT INTO SHARE VALUES ('V211002','C120');
INSERT INTO SHARE VALUES ('V400002','C357');

COMMIT;

--------------------------------------------------
-- 11. T?T C? VIDEO CÓ GI?I H?N TU?I >= 16
--------------------------------------------------
SELECT *
FROM VIDEO
WHERE AGE >= 16;

--------------------------------------------------
-- 12. KÊNH CÓ S? NG??I THEO DÕI NHI?U NH?T
--------------------------------------------------
SELECT *
FROM CHANNEL
WHERE SUBSCRIBES = (SELECT MAX(SUBSCRIBES) FROM CHANNEL);

--------------------------------------------------
-- 13. V?I VIDEO CÓ GI?I H?N TU?I LÀ 18,
--     TH?NG KÊ S? KÊNH ?Ã CHIA S?
--------------------------------------------------
SELECT V.VIDEOID, V.TITLE, COUNT(S.CHANNELID) AS SO_KENH_CHIA_SE
FROM VIDEO V
LEFT JOIN SHARE S ON V.VIDEOID = S.VIDEOID
WHERE V.AGE = 18
GROUP BY V.VIDEOID, V.TITLE;

--------------------------------------------------
-- 14. TÌM VIDEO ???C T?T C? CÁC KÊNH CHIA S?
--------------------------------------------------
SELECT V.VIDEOID, V.TITLE
FROM VIDEO V
JOIN SHARE S ON V.VIDEOID = S.VIDEOID
GROUP BY V.VIDEOID, V.TITLE
HAVING COUNT(DISTINCT S.CHANNELID) = (SELECT COUNT(*) FROM CHANNEL);




